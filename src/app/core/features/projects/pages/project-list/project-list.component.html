<mat-card class="cardWithShadow theme-card">
  <div class="p-6 flex items-center justify-between">
    <mat-card-title class="mb-0"> Listado de proyectos </mat-card-title>

    <button
      mat-flat-button
      color="primary"
      type="button"
      (click)="openNewProjectDialog()"
    >
      Nuevo proyecto
    </button>
  </div>

  <mat-card-content class="border-t border-border">
    @if (!isLoadingProjects && dataSourceProjectList.length) {
      <div class="px-6 pt-5 pb-3">
        <div class="w-full rounded border border-border p-3">
          <mat-form-field appearance="outline" class="w-full mb-0!">
            <mat-label>Buscar en proyectos</mat-label>
            <mat-icon matPrefix class="mr-2 opacity-70">search</mat-icon>
            <input
              matInput
              #searchInput
              [value]="searchProjectTerm"
              (input)="applySearchFilter(searchInput.value)"
              placeholder="Nombre, cliente, vendedor, tipo, valor, estado..."
            />
            @if (searchProjectTerm) {
              <button
                mat-icon-button
                matSuffix
                type="button"
                aria-label="Limpiar búsqueda"
                (click)="clearSearch()"
              >
                <mat-icon>close</mat-icon>
              </button>
            }
          </mat-form-field>
        </div>
      </div>
    }

    @if (isLoadingProjects) {
      <div class="h-[240px] flex items-center justify-center">
        <mat-progress-spinner
          mode="indeterminate"
          diameter="42"
        ></mat-progress-spinner>
      </div>
    } @else if (projectListError) {
      <div class="h-[240px] flex flex-col items-center justify-center gap-3">
        <span class="text-sm text-error">{{ projectListError }}</span>
        <button mat-stroked-button type="button" (click)="loadProjects()">
          Reintentar
        </button>
      </div>
    } @else if (!filteredDataSourceProjectList.length) {
      <div class="h-[240px] flex items-center justify-center">
        @if (searchProjectTerm) {
          <span class="text-sm opacity-70">
            No se encontraron coincidencias para "{{ searchProjectTerm }}".
          </span>
        } @else {
          <span class="text-sm opacity-70">No hay proyectos para mostrar.</span>
        }
      </div>
    } @else {
      <div class="relative overflow-x-hidden">
        <table
          mat-table
          [dataSource]="filteredDataSourceProjectList"
          class="w-full table-fixed"
        >
          <ng-container matColumnDef="projectName">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="font-semibold text-sm pl-0! w-[260px]"
            >
              Nombre del proyecto
            </th>
            <td
              class="whitespace-normal break-words pl-0! align-top"
              mat-cell
              *matCellDef="let element"
            >
              <h6 class="text-sm font-semibold leading-5 whitespace-normal break-words">
                {{ element.name }}
              </h6>
            </td>
          </ng-container>

          <ng-container matColumnDef="client">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="font-semibold text-sm pl-0!"
            >
              Cliente
            </th>
            <td
              class="whitespace-nowrap pl-0!"
              mat-cell
              *matCellDef="let element"
            >
              <div class="flex items-center gap-4">
                <h6 class="text-sm font-semibold">
                  {{ element.clientName }}
                </h6>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="seller">
            <th mat-header-cell *matHeaderCellDef class="font-semibold text-sm">
              Vendedor
            </th>
            <td class="whitespace-nowrap" mat-cell *matCellDef="let element">
              <div class="flex items-center gap-4">
                <h6 class="text-sm font-semibold">
                  {{ element.sellerName }}
                </h6>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="businessType">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="font-semibold text-sm text-center!"
            >
              Tipo de negocio
            </th>
            <td
              class="whitespace-nowrap text-center!"
              mat-cell
              *matCellDef="let element"
            >
              <div class="flex items-center gap-4">
                <h6 class="text-sm font-semibold">
                  {{ element.businessTypeName }}
                </h6>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="stimatedAmount">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="font-semibold text-sm text-center!"
            >
              Valor estimado
            </th>
            <td
              class="whitespace-nowrap text-center!"
              mat-cell
              *matCellDef="let element"
            >
              <div class="flex items-center gap-4">
                <h6 class="text-sm font-semibold">
                  {{ element.estimatedValue | currency: "COP" }}
                </h6>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="font-semibold text-sm text-center!"
            >
              Estado
            </th>
            <td
              class="whitespace-nowrap text-center!"
              mat-cell
              *matCellDef="let element"
            >
              <span [class]="getStatusClass(element.statusCode || element.statusName)">
                {{ formatStatusLabel(element.statusName || element.statusCode) | titlecase }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="options">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="font-semibold text-sm"
            ></th>
            <td
              class="whitespace-nowrap text-end!"
              mat-cell
              *matCellDef="let element"
            >
              <button
                mat-icon-button
                [matMenuTriggerFor]="menu"
                aria-label="Opciones del proyecto"
              >
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #menu="matMenu">
                <button mat-menu-item (click)="openEditProjectDialog(element)">
                  <mat-icon>edit</mat-icon>
                  <span>Editar</span>
                </button>
                @if (canViewNegotiation(element)) {
                  <button mat-menu-item>
                    <mat-icon>bolt</mat-icon>
                    <span>Ver negociación</span>
                  </button>
                }
                <button
                  mat-menu-item
                  [disabled]="deletingProjectId === element.id"
                  (click)="openDeleteProjectDialog(element)"
                >
                  <mat-icon>delete</mat-icon>
                  <span>
                    @if (deletingProjectId === element.id) {
                      Eliminando...
                    } @else {
                      Eliminar
                    }
                  </span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <tr
            mat-header-row
            *matHeaderRowDef="displayedColumnsProjectList"
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumnsProjectList"
          ></tr>
        </table>
      </div>
    }
  </mat-card-content>
</mat-card>
