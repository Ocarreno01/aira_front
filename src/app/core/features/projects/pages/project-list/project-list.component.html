<mat-card class="cardWithShadow theme-card">
  <div class="p-6 flex items-center justify-between">
    <mat-card-title class="mb-0"> Listado de proyectos </mat-card-title>

    <button
      mat-flat-button
      color="primary"
      type="button"
      (click)="openNewProjectDialog()"
    >
      Nuevo proyecto
    </button>
  </div>

  <mat-card-content class="border-t border-border">
    @if (isLoadingProjects) {
      <div class="h-[240px] flex items-center justify-center">
        <mat-progress-spinner
          mode="indeterminate"
          diameter="42"
        ></mat-progress-spinner>
      </div>
    } @else if (projectListError) {
      <div class="h-[240px] flex flex-col items-center justify-center gap-3">
        <span class="text-sm text-error">{{ projectListError }}</span>
        <button mat-stroked-button type="button" (click)="loadProjects()">
          Reintentar
        </button>
      </div>
    } @else if (!dataSourceProjectList.length) {
      <div class="h-[240px] flex items-center justify-center">
        <span class="text-sm opacity-70">No hay proyectos para mostrar.</span>
      </div>
    } @else {
      <div class="relative overflow-auto">
        <table
          mat-table
          [dataSource]="dataSourceProjectList"
          class="min-w-full"
        >
          <ng-container matColumnDef="projectName">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="font-semibold text-sm pl-0!"
            >
              Nombre del proyecto
            </th>
            <td
              class="whitespace-nowrap pl-0!"
              mat-cell
              *matCellDef="let element"
            >
              <div class="flex items-center gap-4">
                <h6 class="text-sm font-semibold">
                  {{ element.name }}
                </h6>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="client">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="font-semibold text-sm pl-0!"
            >
              Cliente
            </th>
            <td
              class="whitespace-nowrap pl-0!"
              mat-cell
              *matCellDef="let element"
            >
              <div class="flex items-center gap-4">
                <h6 class="text-sm font-semibold">
                  {{ element.clientName }}
                </h6>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="seller">
            <th mat-header-cell *matHeaderCellDef class="font-semibold text-sm">
              Vendedor
            </th>
            <td class="whitespace-nowrap" mat-cell *matCellDef="let element">
              <div class="flex items-center gap-4">
                <h6 class="text-sm font-semibold">
                  {{ element.sellerName }}
                </h6>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="businessType">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="font-semibold text-sm text-center!"
            >
              Tipo de negocio
            </th>
            <td
              class="whitespace-nowrap text-center!"
              mat-cell
              *matCellDef="let element"
            >
              <div class="flex items-center gap-4">
                <h6 class="text-sm font-semibold">
                  {{ element.businessTypeName }}
                </h6>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="stimatedAmount">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="font-semibold text-sm text-center!"
            >
              Valor estimado
            </th>
            <td
              class="whitespace-nowrap text-center!"
              mat-cell
              *matCellDef="let element"
            >
              <div class="flex items-center gap-4">
                <h6 class="text-sm font-semibold">
                  {{ element.estimatedValue | currency: "COP" }}
                </h6>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="font-semibold text-sm text-center!"
            >
              Estado
            </th>
            <td
              class="whitespace-nowrap text-center!"
              mat-cell
              *matCellDef="let element"
            >
              <span [class]="getStatusClass(element.statusCode || element.statusName)">
                {{ formatStatusLabel(element.statusName || element.statusCode) | titlecase }}
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="options">
            <th
              mat-header-cell
              *matHeaderCellDef
              class="font-semibold text-sm"
            ></th>
            <td
              class="whitespace-nowrap text-end!"
              mat-cell
              *matCellDef="let element"
            >
              <button
                mat-icon-button
                [matMenuTriggerFor]="menu"
                aria-label="Opciones del proyecto"
              >
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #menu="matMenu">
                <button mat-menu-item (click)="openEditProjectDialog(element)">
                  <mat-icon>edit</mat-icon>
                  <span>Editar</span>
                </button>
                @if (canViewNegotiation(element)) {
                  <button mat-menu-item>
                    <mat-icon>bolt</mat-icon>
                    <span>Ver negociaci√≥n</span>
                  </button>
                }
                <button
                  mat-menu-item
                  [disabled]="deletingProjectId === element.id"
                  (click)="openDeleteProjectDialog(element)"
                >
                  <mat-icon>delete</mat-icon>
                  <span>
                    @if (deletingProjectId === element.id) {
                      Eliminando...
                    } @else {
                      Eliminar
                    }
                  </span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <tr
            mat-header-row
            *matHeaderRowDef="displayedColumnsProjectList"
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumnsProjectList"
          ></tr>
        </table>
      </div>
    }
  </mat-card-content>
</mat-card>
